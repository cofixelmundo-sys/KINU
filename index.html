<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KINU Studio - AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>

    <style>
        .checkerboard {
            background-image: linear-gradient(45deg, #2a2a2a 25%, transparent 25%), 
                              linear-gradient(-45deg, #2a2a2a 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #2a2a2a 75%), 
                              linear-gradient(-45deg, transparent 75%, #2a2a2a 75%);
            background-size: 20px 20px;
            background-color: #1a1a1a;
        }
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-zinc-900 text-white min-h-screen flex flex-col items-center justify-center p-4 overflow-hidden">

    <div class="relative w-full max-w-sm aspect-[3/4] bg-zinc-800 rounded-[30px] overflow-hidden border border-zinc-700 shadow-2xl checkerboard">
        <div id="loading-overlay" class="absolute inset-0 z-20 flex flex-col items-center justify-center bg-zinc-900">
            <div class="loader mb-4"></div>
            <p id="status-text" class="text-[10px] font-bold tracking-widest uppercase opacity-60 text-center px-6">
                Iniciando motor de IA...<br>(Puede tardar 10s la primera vez)
            </p>
        </div>
        
        <canvas id="canvas" class="w-full h-full object-contain relative z-10"></canvas>
    </div>

    <div class="mt-8 w-full max-w-sm px-4">
        <button id="btn-confirm" onclick="confirmarYVolver()" class="w-full bg-white text-black font-black py-4 rounded-full text-xs uppercase tracking-widest hidden">
            USAR PRENDA
        </button>
        <p id="error-msg" class="text-red-400 text-[10px] text-center uppercase tracking-widest hidden">Error al procesar la imagen</p>
    </div>

    <script>
        let bodypix;
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        async function setup() {
            // Cargamos el modelo BodyPix con configuración ligera para móvil
            const options = {
                outputStride: 16,
                multiplier: 0.50, // Modelo más ligero
                architecture: 'MobileNetV1'
            };
            
            bodypix = ml5.bodyPix(options, modelReady);
        }

        function modelReady() {
            document.getElementById('status-text').innerText = "IA LISTA. RECORTANDO...";
            procesar();
        }

        function procesar() {
            const dataUrl = localStorage.getItem('imagen_transferida');
            if (!dataUrl) return;

            const img = new Image();
            img.src = dataUrl;
            img.onload = () => {
                // Ajustamos el canvas para que no exceda 800px (evita errores de memoria)
                const maxDim = 800;
                let w = img.width;
                let h = img.height;
                
                if (w > h && w > maxDim) { h *= maxDim/w; w = maxDim; }
                else if (h > maxDim) { w *= maxDim/h; h = maxDim; }

                canvas.width = w;
                canvas.height = h;
                ctx.drawImage(img, 0, 0, w, h);

                // Ejecutar segmentación
                bodypix.segment(canvas, (err, result) => {
                    if (err) {
                        console.error(err);
                        document.getElementById('error-msg').classList.remove('hidden');
                        return;
                    }
                    
                    const mask = result.backgroundMask;
                    // Dibujamos la máscara sobre la imagen original para recortar
                    ctx.globalCompositeOperation = 'destination-in';
                    ctx.drawImage(mask, 0, 0, w, h);
                    
                    // Finalizar
                    document.getElementById('loading-overlay').style.display = 'none';
                    document.getElementById('btn-confirm').classList.remove('hidden');
                    
                    // Guardar
                    const finalBase64 = canvas.toDataURL("image/png");
                    localStorage.setItem('imagen_procesada', finalBase64);
                });
            };
        }

        function confirmarYVolver() {
            if (window.parent && window.parent.cerrarIA) {
                window.parent.cerrarIA();
            }
        }

        window.onload = setup;
    </script>
</body>
</html>
