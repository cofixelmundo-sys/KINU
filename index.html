<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KINU Studio</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root { --verde-oliva: #848464; --verde-oscuro: #313628; --arena: #F2EFE9; --arena-boton: #E5E1D5; }
        body { font-family: -apple-system, sans-serif; background: var(--verde-oliva); margin: 0; height: 100dvh; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; overflow: hidden; }
        
        #preview-container { width: 90%; height: 50vh; border-radius: 25px; background: rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; border: 2px dashed rgba(255,255,255,0.2); margin-bottom: 20px; }
        img { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        .loader { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.2); border-top-color: var(--arena); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* MODAL DE CATEGORÍAS */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(8px); }
        .cat-popup { background: var(--arena); border-radius: 30px; width: 85%; max-width: 350px; padding: 25px; color: var(--verde-oscuro); box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
        .cat-header { font-weight: 800; text-align: center; text-transform: uppercase; font-size: 14px; margin-bottom: 20px; color: var(--verde-oliva); letter-spacing: 1px; }
        .cat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .cat-btn { background: var(--arena-boton); border: none; padding: 12px 5px; border-radius: 15px; display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; }
        .cat-btn i { font-size: 20px; color: var(--verde-oscuro); }
        .cat-btn span { font-size: 8px; font-weight: 700; text-transform: uppercase; }
        
        .btn-cancelar { margin-top: 25px; color: rgba(255,255,255,0.5); background: none; border: none; cursor: pointer; text-transform: uppercase; font-size: 11px; font-weight: 700; }
    </style>
</head>
<body>

    <div id="preview-container">
        <img id="img-target" src="">
    </div>

    <div id="status-area" style="text-align: center;">
        <div class="loader" id="loader"></div>
        <p id="status-text" style="text-transform: uppercase; font-size: 12px; letter-spacing: 1px;">Recortando prenda...</p>
    </div>

    <button class="btn-cancelar" onclick="cancelar()">Cancelar y salir</button>

    <div id="modal-cat" class="modal-overlay">
        <div class="cat-popup">
            <div class="cat-header">¿DÓNDE GUARDAMOS ESTO?</div>
            <div id="cat-list" class="cat-grid"></div>
        </div>
    </div>

    <script>
        const HF_TOKEN = "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";
        const API_URL = "https://api-inference.huggingface.co/models/briaai/RMBG-1.4";
        
        const categorias = [
            {n: 'Superior', i: 'ph-t-shirt'}, {n: 'Inferior', i: 'ph-pants'}, {n: 'Abrigos', i: 'ph-hoodie'}, 
            {n: 'Calzado', i: 'ph-sneaker'}, {n: 'Vestidos', i: 'ph-dress'}, {n: 'Bolsos', i: 'ph-handbag'},
            {n: 'Accesorios', i: 'ph-watch'}, {n: 'Vintage', i: 'ph-hourglass-high'}, {n: 'Colaboro', i: 'ph-handshake'}, 
            {n: 'Deporte', i: 'ph-barbell'}, {n: 'Interior', i: 'ph-heart-straight'}, {n: 'Joyas', i: 'ph-sketch-logo'}
        ];

        window.onload = async () => {
            const rawImg = localStorage.getItem('temp_image');
            if (!rawImg) { window.location.href = 'index.html'; return; }
            document.getElementById('img-target').src = rawImg;
            procesarImagen(rawImg);
        };

        async function procesarImagen(base64) {
            try {
                const response = await fetch(base64);
                const blob = await response.blob();

                const res = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${HF_TOKEN}` },
                    body: blob
                });

                if (res.status === 503) {
                    setTimeout(() => procesarImagen(base64), 3000);
                    return;
                }

                const resultBlob = await res.blob();
                const reader = new FileReader();
                reader.onloadend = () => {
                    localStorage.setItem('final_image', reader.result);
                    document.getElementById('img-target').src = reader.result;
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('status-text').innerText = "Recorte listo";
                    abrirSeleccionCategoria();
                };
                reader.readAsDataURL(resultBlob);

            } catch (err) {
                document.getElementById('status-text').innerText = "Error de conexión. Reintentando...";
                setTimeout(() => procesarImagen(base64), 3000);
            }
        }

        function abrirSeleccionCategoria() {
            const list = document.getElementById('cat-list');
            list.innerHTML = '';
            categorias.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'cat-btn';
                btn.innerHTML = `<i class="ph ${cat.i}"></i><span>${cat.n}</span>`;
                btn.onclick = () => guardarYSalir(cat.n.toUpperCase());
                list.appendChild(btn);
            });
            document.getElementById('modal-cat').style.display = 'flex';
        }

        function guardarYSalir(cat) {
            localStorage.setItem('temp_category', cat);
            window.location.href = 'index.html';
        }

        function cancelar() {
            localStorage.removeItem('temp_image');
            localStorage.removeItem('final_image');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
