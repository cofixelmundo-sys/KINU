<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KINU Studio - AI Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .checkerboard {
            background-image: linear-gradient(45deg, #2a2a2a 25%, transparent 25%), 
                              linear-gradient(-45deg, #2a2a2a 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #2a2a2a 75%), 
                              linear-gradient(-45deg, transparent 75%, #2a2a2a 75%);
            background-size: 15px 15px;
        }
        .loading-ring {
            border-top-color: #6366f1;
            animation: spinner 0.6s linear infinite;
        }
        @keyframes spinner { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-black text-white min-h-screen flex flex-col items-center justify-center p-4">

    <div class="relative w-full max-w-[320px] aspect-[3/4] bg-zinc-900 rounded-[40px] overflow-hidden border border-zinc-800 shadow-2xl">
        <div id="overlay" class="absolute inset-0 z-20 flex flex-col items-center justify-center bg-zinc-950/90 backdrop-blur-md">
            <div id="loader" class="w-12 h-12 border-4 border-zinc-800 loading-ring rounded-full mb-4"></div>
            <p id="status" class="text-indigo-400 text-sm font-bold tracking-widest uppercase">Buscando Foto...</p>
            <p id="substatus" class="text-zinc-500 text-[11px] mt-2 px-8 text-center">Asegúrate de haber subido la foto en la app antes de abrir este editor.</p>
        </div>

        <div class="absolute inset-0 checkerboard"></div>
        <img id="preview" class="relative z-10 w-full h-full object-contain p-4 opacity-0 transition-opacity duration-700">
    </div>

    <div class="mt-10 w-full max-w-[320px]">
        <button id="mainBtn" onclick="finalizar()" disabled class="w-full py-4 bg-zinc-800 text-zinc-500 rounded-2xl font-black text-xs uppercase tracking-[0.2em] transition-all duration-300">
            Esperando Procesamiento
        </button>
        <p class="text-[9px] text-zinc-600 text-center mt-6 tracking-[0.3em] uppercase">KINU Studio © 2026 • AI Engine</p>
    </div>

    <script>
        const API_KEY = 'DMyvHPSJGrrKqVpFzkMB1ua8';
        const IMG_KEYS = ['temp_img_url', 'glide_image_url', 'last_photo', 'image_url'];
        let checkInterval;

        // 1. ESCUCHA ACTIVA: Busca la foto cada 500ms
        function iniciarEscucha() {
            checkInterval = setInterval(() => {
                let foundUrl = null;
                for (let key of IMG_KEYS) {
                    let val = sessionStorage.getItem(key);
                    if (val && val.startsWith('http')) {
                        foundUrl = val;
                        break;
                    }
                }

                if (foundUrl) {
                    clearInterval(checkInterval); // Detener búsqueda
                    ejecutarIA(foundUrl);
                }
            }, 500);
        }

        // 2. PROCESO CON REMOVE.BG
        async function ejecutarIA(url) {
            actualizarEstado("Eliminando Fondo", "Conectando con la IA...");
            
            try {
                const res = await fetch('https://api.remove.bg/v1.0/removebg', {
                    method: 'POST',
                    headers: { 'X-Api-Key': API_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image_url: url, size: 'auto' })
                });

                if (res.ok) {
                    const blob = await res.blob();
                    recortarYOptimizar(blob);
                } else {
                    mostrarError("Error de Créditos", "Revisa tu cuenta de remove.bg");
                }
            } catch (e) {
                mostrarError("Error de Red", "Revisa tu conexión a internet");
            }
        }

        // 3. RECORTAR BORDES TRANSPARENTES (AUTOCROP)
        function recortarYOptimizar(blob) {
            actualizarEstado("Ajustando Foto", "Recortando espacios vacíos...");
            const img = new Image();
            img.src = URL.createObjectURL(blob);
            
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d', { willReadFrequently: true });
                
                // Limitar tamaño para rapidez en móviles
                const max = 1200;
                let w = img.width, h = img.height;
                if(w > max || h > max) {
                    const r = Math.min(max/w, max/h);
                    w *= r; h *= r;
                }

                canvas.width = w; canvas.height = h;
                ctx.drawImage(img, 0, 0, w, h);
                
                const pixels = ctx.getImageData(0, 0, w, h).data;
                let minX = w, minY = h, maxX = 0, maxY = 0, hasPixels = false;

                for (let y = 0; y < h; y += 4) {
                    for (let x = 0; x < w; x += 4) {
                        if (pixels[(y * w + x) * 4 + 3] > 30) {
                            if (x < minX) minX = x; if (y < minY) minY = y;
                            if (x > maxX) maxX = x; if (y > maxY) maxY = y;
                            hasPixels = true;
                        }
                    }
                }

                const finalCanvas = document.createElement('canvas');
                const pad = 20;
                if (!hasPixels) { minX=0; minY=0; maxX=w; maxY=h; }

                finalCanvas.width = (maxX - minX) + pad;
                finalCanvas.height = (maxY - minY) + pad;
                const fCtx = finalCanvas.getContext('2d');
                fCtx.drawImage(img, minX, minY, (maxX-minX), (maxY-minY), pad/2, pad/2, (maxX-minX), (maxY-minY));
                
                const result = finalCanvas.toDataURL("image/png", 0.8);
                
                // Mostrar resultado
                document.getElementById('preview').src = result;
                document.getElementById('preview').classList.remove('opacity-0');
                document.getElementById('overlay').style.display = 'none';
                
                // Activar Botón
                const btn = document.getElementById('mainBtn');
                btn.disabled = false;
                btn.innerText = "Confirmar y Guardar";
                btn.className = "w-full py-4 bg-indigo-600 text-white rounded-2xl font-black text-xs uppercase tracking-[0.2em] shadow-[0_0_20px_rgba(99,102,241,0.4)] active:scale-95 transition-all";

                sessionStorage.setItem('imagen_procesada', result);
            };
        }

        function actualizarEstado(txt, sub) {
            document.getElementById('status').innerText = txt;
            document.getElementById('substatus').innerText = sub;
        }

        function mostrarError(txt, sub) {
            document.getElementById('loader').style.borderColor = "#ef4444";
            document.getElementById('status').innerText = txt;
            document.getElementById('status').className = "text-red-500 text-sm font-bold uppercase";
            document.getElementById('substatus').innerText = sub;
        }

        function finalizar() {
            // Comunicación con la App principal
            if (window.parent) {
                window.parent.postMessage("completado", "*");
                try { window.parent.cerrarIA(); } catch(e) {}
            }
            alert("¡Foto lista! Ya puedes volver.");
        }

        window.onload = iniciarEscucha;
    </script>
</body>
</html>
