<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KINU Studio AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .checkerboard {
            background-image: linear-gradient(45deg, #2a2a2a 25%, transparent 25%), 
                              linear-gradient(-45deg, #2a2a2a 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #2a2a2a 75%), 
                              linear-gradient(-45deg, transparent 75%, #2a2a2a 75%);
            background-size: 15px 15px;
        }
    </style>
</head>
<body class="bg-zinc-950 text-white min-h-screen flex flex-col items-center justify-center p-6">

    <div class="mb-8 text-center">
        <h1 class="text-indigo-500 font-black tracking-widest text-xl uppercase">KINU STUDIO</h1>
        <p id="status-text" class="text-zinc-500 text-xs mt-2 uppercase tracking-widest">Editor de Retrato IA</p>
    </div>

    <div class="relative w-full max-w-[320px] aspect-[3/4] bg-zinc-900 rounded-[40px] overflow-hidden border border-white/5 shadow-2xl">
        
        <div id="drop-zone" class="absolute inset-0 z-30 flex flex-col items-center justify-center bg-zinc-900 px-6 text-center">
            <div class="w-16 h-16 bg-indigo-600/20 rounded-full flex items-center justify-center mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
            </div>
            <p class="text-sm font-bold mb-2">Paso 1: Selecciona tu foto</p>
            <p class="text-zinc-500 text-[11px] mb-6">La IA detectará tu silueta y eliminará el fondo automáticamente.</p>
            
            <label class="bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold py-3 px-8 rounded-full cursor-pointer transition-all active:scale-95">
                ELEGIR IMAGEN
                <input type="file" id="file-input" class="hidden" accept="image/*">
            </label>
        </div>

        <div id="loading-overlay" class="hidden absolute inset-0 z-40 flex flex-col items-center justify-center bg-zinc-950/90 backdrop-blur-md">
            <div class="w-10 h-10 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p id="loader-msg" class="text-xs font-bold tracking-widest text-indigo-400 uppercase">Procesando...</p>
        </div>

        <div class="absolute inset-0 checkerboard opacity-30"></div>
        <img id="result-img" class="relative z-10 w-full h-full object-contain p-4 opacity-0 transition-opacity duration-500">
    </div>

    <button id="final-btn" onclick="confirmar()" disabled class="mt-10 w-full max-w-[320px] py-4 bg-zinc-800 text-zinc-600 rounded-2xl font-bold text-xs uppercase tracking-[0.2em] transition-all">
        Confirmar Resultado
    </button>

    <script>
        const API_KEY = 'DMyvHPSJGrrKqVpFzkMB1ua8';
        const fileInput = document.getElementById('file-input');
        
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Mostrar carga
            document.getElementById('loading-overlay').classList.remove('hidden');
            document.getElementById('drop-zone').classList.add('hidden');
            
            try {
                const formData = new FormData();
                formData.append('image_file', file);
                formData.append('size', 'auto');

                const response = await fetch('https://api.remove.bg/v1.0/removebg', {
                    method: 'POST',
                    headers: { 'X-Api-Key': API_KEY },
                    body: formData
                });

                if (response.ok) {
                    const blob = await response.blob();
                    procesarRecorte(blob);
                } else {
                    alert("Error en la IA. Verifica tus créditos de remove.bg");
                    location.reload();
                }
            } catch (err) {
                alert("Error de conexión");
                location.reload();
            }
        });

        function procesarRecorte(blob) {
            const img = new Image();
            img.src = URL.createObjectURL(blob);
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d', { willReadFrequently: true });
                
                // Optimización de tamaño
                const scale = Math.min(1000 / img.width, 1);
                canvas.width = img.width * scale;
                canvas.height = img.height * scale;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                const data = ctx.getImageData(0,0,canvas.width,canvas.height).data;
                let minX=canvas.width, minY=canvas.height, maxX=0, maxY=0;

                for(let y=0; y<canvas.height; y+=4) {
                    for(let x=0; x<canvas.width; x+=4) {
                        if(data[(y*canvas.width+x)*4+3] > 30) {
                            if(x<minX) minX=x; if(y<minY) minY=y;
                            if(x>maxX) maxX=x; if(y>maxY) maxY=y;
                        }
                    }
                }

                const finalCanvas = document.createElement('canvas');
                const p = 20;
                finalCanvas.width = (maxX-minX)+p;
                finalCanvas.height = (maxY-minY)+p;
                finalCanvas.getContext('2d').drawImage(img, minX, minY, maxX-minX, maxY-minY, p/2, p/2, maxX-minX, maxY-minY);
                
                const base64 = finalCanvas.toDataURL("image/png", 0.8);
                
                // Mostrar UI final
                document.getElementById('result-img').src = base64;
                document.getElementById('result-img').classList.remove('opacity-0');
                document.getElementById('loading-overlay').classList.add('hidden');
                
                const btn = document.getElementById('final-btn');
                btn.disabled = false;
                btn.innerText = "CONFIRMAR Y GUARDAR";
                btn.className = "mt-10 w-full max-w-[320px] py-4 bg-indigo-600 text-white rounded-2xl font-black text-xs uppercase tracking-[0.2em] shadow-lg shadow-indigo-500/20 active:scale-95 transition-all";
                
                sessionStorage.setItem('imagen_procesada', base64);
            }
        }

        function confirmar() {
            if (window.parent) {
                window.parent.postMessage("completado", "*");
            }
            alert("¡Foto guardada correctamente!");
        }
    </script>
</body>
</html>
