<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KINU Studio - Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .checkerboard {
            background-image: linear-gradient(45deg, #2a2a2a 25%, transparent 25%), 
                              linear-gradient(-45deg, #2a2a2a 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #2a2a2a 75%), 
                              linear-gradient(-45deg, transparent 75%, #2a2a2a 75%);
            background-size: 15px 15px;
        }
    </style>
</head>
<body class="bg-zinc-900 text-white min-h-screen flex flex-col items-center justify-center p-4">

    <div class="relative w-full max-w-xs aspect-[3/4] bg-zinc-800 rounded-[30px] overflow-hidden border border-zinc-700 shadow-xl">
        <div id="loading" class="absolute inset-0 z-20 flex flex-col items-center justify-center bg-zinc-900/90 backdrop-blur-sm">
            <div id="spinner" class="w-10 h-10 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin mb-3"></div>
            <p id="statusText" class="text-indigo-400 text-sm font-medium px-6 text-center">Buscando foto en la sesión...</p>
            
            <button id="manualBtn" onclick="reintentarManual()" class="hidden mt-4 text-xs bg-zinc-700 px-4 py-2 rounded-full text-zinc-300">
                Reintentar detección
            </button>
        </div>

        <div class="absolute inset-0 checkerboard"></div>
        <img id="resultImage" class="relative z-10 w-full h-full object-contain p-4 opacity-0 transition-opacity duration-500">
    </div>

    <div class="mt-6 text-center w-full max-w-xs">
        <button id="saveBtn" onclick="confirmarYVolver()" class="w-full py-4 bg-white text-black rounded-2xl font-bold text-sm opacity-50 cursor-not-allowed shadow-lg transition-all" disabled>
            ESPERANDO...
        </button>
        <p class="text-zinc-500 text-[10px] mt-4 uppercase tracking-widest">KINU Studio AI Engine</p>
    </div>

    <script>
        const API_KEY = 'DMyvHPSJGrrKqVpFzkMB1ua8';
        let intentos = 0;

        async function buscarImagen() {
            // Buscamos en todas las keys posibles que suelen usar Glide, Adalo o scripts personalizados
            const posiblesKeys = ['temp_img_url', 'glide_image_url', 'last_photo', 'current_img', 'image'];
            let urlEncontrada = null;

            for (let key of posiblesKeys) {
                const val = sessionStorage.getItem(key);
                if (val && val.startsWith('http')) {
                    urlEncontrada = val;
                    break;
                }
            }

            if (urlEncontrada) {
                procesarConIA(urlEncontrada);
            } else {
                intentos++;
                if (intentos < 10) {
                    setTimeout(buscarImagen, 1000); // Reintenta cada segundo
                } else {
                    document.getElementById('spinner').classList.add('hidden');
                    document.getElementById('statusText').innerHTML = "No se recibió la foto de la App.<br><span class='text-xs font-normal text-zinc-500'>Asegúrate de haber sacado la foto correctamente.</span>";
                    document.getElementById('manualBtn').classList.remove('hidden');
                }
            }
        }

        async function procesarConIA(url) {
            document.getElementById('statusText').innerText = "IA quitando fondo...";
            document.getElementById('manualBtn').classList.add('hidden');

            try {
                const response = await fetch('https://api.remove.bg/v1.0/removebg', {
                    method: 'POST',
                    headers: { 'X-Api-Key': API_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image_url: url, size: 'auto' })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    recortarTransparencia(blob);
                } else {
                    const err = await response.json();
                    mostrarError("Error IA: " + (err.errors[0].title || "Verifica créditos"));
                }
            } catch (e) {
                mostrarError("Error de conexión");
            }
        }

        function recortarTransparencia(blob) {
            document.getElementById('statusText').innerText = "Recortando bordes...";
            const img = new Image();
            img.src = URL.createObjectURL(blob);
            
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d', { willReadFrequently: true });
                
                // Redimensionar para fluidez
                const scale = Math.min(1200 / img.width, 1200 / img.height, 1);
                canvas.width = img.width * scale;
                canvas.height = img.height * scale;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
                let minX = canvas.width, minY = canvas.height, maxX = 0, maxY = 0;

                for (let y = 0; y < canvas.height; y += 4) {
                    for (let x = 0; x < canvas.width; x += 4) {
                        if (data[(y * canvas.width + x) * 4 + 3] > 20) {
                            if (x < minX) minX = x; if (y < minY) minY = y;
                            if (x > maxX) maxX = x; if (y > maxY) maxY = y;
                        }
                    }
                }

                const finalCanvas = document.createElement('canvas');
                const p = 20; // Padding
                finalCanvas.width = (maxX - minX) + p;
                finalCanvas.height = (maxY - minY) + p;
                finalCanvas.getContext('2d').drawImage(img, minX, minY, (maxX-minX), (maxY-minY), p/2, p/2, (maxX-minX), (maxY-minY));
                
                const resultBase64 = finalCanvas.toDataURL("image/png", 0.8);
                document.getElementById('resultImage').src = resultBase64;
                document.getElementById('resultImage').classList.remove('opacity-0');
                document.getElementById('loading').style.display = 'none';
                
                const btn = document.getElementById('saveBtn');
                btn.disabled = false;
                btn.innerText = "FINALIZAR Y GUARDAR";
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.classList.add('bg-indigo-600', 'text-white');

                sessionStorage.setItem('imagen_procesada', resultBase64);
            };
        }

        function reintentarManual() {
            intentos = 0;
            document.getElementById('spinner').classList.remove('hidden');
            document.getElementById('statusText').innerText = "Buscando foto...";
            document.getElementById('manualBtn').classList.add('hidden');
            buscarImagen();
        }

        function mostrarError(msg) {
            document.getElementById('spinner').classList.add('hidden');
            document.getElementById('statusText').innerText = msg;
            document.getElementById('statusText').classList.add('text-red-500');
        }

        function confirmarYVolver() {
            if (window.parent && window.parent.postMessage) {
                window.parent.postMessage("completado", "*");
            }
            // Intento de llamar a función específica de Studio si existe
            try { window.parent.cerrarIA(); } catch(e) {}
            alert("Imagen procesada. Vuelve a la aplicación.");
        }

        window.onload = buscarImagen;
    </script>
</body>
</html>
