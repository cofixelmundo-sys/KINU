<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KINU Studio IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .checkerboard {
            background-image: linear-gradient(45deg, #2a2a2a 25%, transparent 25%), 
                              linear-gradient(-45deg, #2a2a2a 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #2a2a2a 75%), 
                              linear-gradient(-45deg, transparent 75%, #2a2a2a 75%);
            background-size: 15px 15px;
            background-color: #1a1a1a;
        }
    </style>
</head>
<body class="bg-zinc-900 text-white min-h-screen flex flex-col items-center justify-center p-6">

    <div class="relative w-full max-w-xs aspect-[3/4] bg-zinc-800 rounded-[30px] overflow-hidden border border-zinc-700 shadow-xl">
        <div id="loading" class="absolute inset-0 z-20 flex flex-col items-center justify-center bg-zinc-900/80 backdrop-blur-sm">
            <div class="w-10 h-10 border-4 border-white/20 border-t-white rounded-full animate-spin mb-4"></div>
            <p class="text-xs font-bold tracking-widest uppercase">Procesando IA...</p>
        </div>
        
        <div class="absolute inset-0 checkerboard flex items-center justify-center">
            <img id="resultImage" class="max-w-full max-height-full object-contain opacity-0 transition-opacity duration-500" alt="Resultado">
        </div>
    </div>

    <div class="mt-8 w-full max-w-xs space-y-3">
        <button onclick="confirmarYVolver()" class="w-full bg-white text-black py-4 rounded-full font-black text-xs uppercase tracking-widest shadow-lg active:scale-95 transition-transform">
            LISTO, GUARDAR
        </button>
        <button onclick="window.parent.cerrarIA()" class="w-full bg-transparent border border-white/20 text-white/50 py-3 rounded-full font-bold text-[10px] uppercase tracking-widest active:scale-95 transition-all">
            CANCELAR
        </button>
    </div>

    <script>
        window.onload = async () => {
            // 1. Obtener la imagen enviada desde index.html
            const base64Original = localStorage.getItem('imagen_transferida');
            
            if (!base64Original) {
                document.getElementById('loading').innerHTML = '<p class="text-red-500 text-[10px]">ERROR: NO SE RECIBIÓ IMAGEN</p>';
                return;
            }

            try {
                // 2. Convertir Base64 a Blob para la API
                const byteString = atob(base64Original.split(',')[1]);
                const mimeString = base64Original.split(',')[0].split(':')[1].split(';')[0];
                const ab = new ArrayBuffer(byteString.length);
                const ia = new Uint8Array(ab);
                for (let i = 0; i < byteString.length; i++) {
                    ia[i] = byteString.charCodeAt(i);
                }
                const blob = new Blob([ab], {type: mimeString});

                // 3. Llamada a la API de Remove.bg
                const formData = new FormData();
                formData.append('image_file', blob);
                formData.append('size', 'auto');

                const response = await fetch('https://api.remove.bg/v1.0/removebg', {
                    method: 'POST',
                    headers: { 'X-Api-Key': 'DMyvHPSJGrrKqVpFzkMB1ua8' }, // Asegúrate de tener créditos
                    body: formData
                });

                if (response.ok) {
                    const resultBlob = await response.blob();
                    const reader = new FileReader();
                    
                    reader.onloadend = () => {
                        const img = new Image();
                        img.src = reader.result;
                        
                        img.onload = () => {
                            // 4. Recorte automático de bordes transparentes sobrantes
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            ctx.drawImage(img, 0, 0);
                            
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const data = imageData.data;
                            let minX = canvas.width, minY = canvas.height, maxX = 0, maxY = 0;

                            for (let y = 0; y < canvas.height; y++) {
                                for (let x = 0; x < canvas.width; x++) {
                                    if (data[(y * canvas.width + x) * 4 + 3] > 0) {
                                        if (x < minX) minX = x; if (y < minY) minY = y;
                                        if (x > maxX) maxX = x; if (y > maxY) maxY = y;
                                    }
                                }
                            }

                            const cropCanvas = document.createElement('canvas');
                            cropCanvas.width = (maxX - minX) + 1;
                            cropCanvas.height = (maxY - minY) + 1;
                            cropCanvas.getContext('2d').drawImage(img, minX, minY, cropCanvas.width, cropCanvas.height, 0, 0, cropCanvas.width, cropCanvas.height);
                            
                            const finalBase64 = cropCanvas.toDataURL("image/png");

                            // 5. Guardar el resultado para que index.html lo use
                            localStorage.setItem('imagen_procesada', finalBase64);
                            
                            const displayImg = document.getElementById('resultImage');
                            displayImg.src = finalBase64;
                            displayImg.classList.remove('opacity-0');
                            document.getElementById('loading').style.display = 'none';
                        };
                    };
                    reader.readAsDataURL(resultBlob);
                } else {
                    const err = await response.json();
                    document.getElementById('loading').innerHTML = `<p class="text-red-500 text-[10px] text-center px-4">ERROR API:<br>${err.errors[0].title}</p>`;
                }
            } catch (err) {
                document.getElementById('loading').innerHTML = '<p class="text-red-500 text-[10px]">ERROR DE CONEXIÓN</p>';
            }
        };

        function confirmarYVolver() {
            // Avisa al index.html que el proceso terminó
            if (window.parent && window.parent.cerrarIA) {
                window.parent.cerrarIA();
            }
        }
    </script>
</body>
</html>
